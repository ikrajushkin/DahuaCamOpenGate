#!/bin/bash
# update.sh — обновление DahuaCamOpenGate из GitHub и перезапуск службы

set -euo pipefail

APP_DIR="/opt/dahua-gate"
SERVICE="dahua-gate"
PIP="$APP_DIR/env/bin/pip"
SSH_KEY="/var/lib/www-data/.ssh/id_ed25519"

# ---------------------------------------------------------------------------
# Цвета для вывода
# ---------------------------------------------------------------------------
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # сброс цвета

ok()   { echo -e "${GREEN}[OK]${NC} $*"; }
warn() { echo -e "${YELLOW}[!!]${NC} $*"; }
fail() { echo -e "${RED}[ERROR]${NC} $*"; exit 1; }

# ---------------------------------------------------------------------------
# 1. Проверка прав
# ---------------------------------------------------------------------------
if [[ $EUID -ne 0 ]]; then
    fail "Запустите скрипт с правами root: sudo ./update.sh"
fi

echo "=========================================="
echo " DahuaCamOpenGate — обновление"
echo "=========================================="

cd "$APP_DIR" || fail "Директория $APP_DIR не найдена"

# ---------------------------------------------------------------------------
# 2. Проверка SSH-доступа к GitHub
# ---------------------------------------------------------------------------
echo ""
echo "--- Проверка SSH-доступа к GitHub ---"

if [[ ! -f "$SSH_KEY" ]]; then
    fail "SSH Deploy Key не найден: $SSH_KEY\nНастройте ключ согласно разделу 2 инструкции DEPLOY.md"
fi

SSH_TEST=$(sudo -u www-data ssh -T git@github.com 2>&1 || true)

if echo "$SSH_TEST" | grep -q "successfully authenticated"; then
    ok "SSH-доступ к GitHub подтверждён"
else
    fail "Нет SSH-доступа к GitHub.\nОтвет сервера: $SSH_TEST\nПроверьте Deploy Key в настройках репозитория."
fi

# ---------------------------------------------------------------------------
# 3. Проверить наличие обновлений
# ---------------------------------------------------------------------------
echo ""
echo "--- Проверка обновлений ---"
sudo -u www-data git fetch origin main

COMMITS_BEHIND=$(sudo -u www-data git rev-list HEAD..origin/main --count)

if [[ "$COMMITS_BEHIND" -eq 0 ]]; then
    ok "Уже установлена актуальная версия. Обновление не требуется."
    exit 0
fi

echo ""
warn "Доступно новых коммитов: $COMMITS_BEHIND"
echo ""
echo "Список изменений:"
sudo -u www-data git log HEAD..origin/main --oneline
echo ""
echo "Изменённые файлы:"
sudo -u www-data git diff HEAD origin/main --name-only

# ---------------------------------------------------------------------------
# 4. Проверить, изменился ли requirements.txt
# ---------------------------------------------------------------------------
REQS_CHANGED=$(sudo -u www-data git diff HEAD origin/main --name-only | grep -c "requirements.txt" || true)

# ---------------------------------------------------------------------------
# 5. Получить обновление
# ---------------------------------------------------------------------------
echo ""
echo "--- Получение обновления ---"
sudo -u www-data git pull origin main
ok "Код обновлён"

# ---------------------------------------------------------------------------
# 6. Обновить зависимости (только если requirements.txt изменился)
# ---------------------------------------------------------------------------
if [[ "$REQS_CHANGED" -gt 0 ]]; then
    echo ""
    echo "--- Обновление зависимостей ---"
    sudo -u www-data "$PIP" install -r requirements.txt
    ok "Зависимости обновлены"
else
    ok "requirements.txt не изменился, pip пропущен"
fi

# ---------------------------------------------------------------------------
# 7. Перезапустить службу
# ---------------------------------------------------------------------------
echo ""
echo "--- Перезапуск службы ---"
systemctl restart "$SERVICE"
sleep 2

# ---------------------------------------------------------------------------
# 8. Проверить статус
# ---------------------------------------------------------------------------
if systemctl is-active --quiet "$SERVICE"; then
    ok "Служба $SERVICE запущена"
else
    fail "Служба $SERVICE не запустилась. Проверьте логи: journalctl -u $SERVICE -n 50"
fi

# ---------------------------------------------------------------------------
# 9. HTTP-проверка
# ---------------------------------------------------------------------------
echo ""
echo "--- Проверка HTTP ---"
PORT=$(sudo -u www-data grep -Po '(?<=SERVER_PORT=)\d+' "$APP_DIR/.env.prod" 2>/dev/null || echo "5000")
HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "http://localhost:$PORT/health" || true)

if [[ "$HTTP_STATUS" == "200" ]]; then
    ok "GET /health → HTTP $HTTP_STATUS"
else
    warn "GET /health → HTTP $HTTP_STATUS (сервер может ещё запускаться)"
fi

# ---------------------------------------------------------------------------
# 10. Итог
# ---------------------------------------------------------------------------
echo ""
echo "=========================================="
ok "Обновление завершено успешно"
echo "  Версия: $(sudo -u www-data git log -1 --format='%h %s (%ad)' --date=short)"
echo "=========================================="
